<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Hunt Tracker</title>
  <style type="text/css">
    html {
      font-family: sans-serif;
    }

    body,
    #page-container,
    #left-menu,
    #right-contents {
      margin: 0;
      padding: 0;
    }

    /* Init Welcome Dialog */

    #init-dialog {
      z-index: 90;
      border: 4px solid black;
      border-radius: 20px;
      background-color: #DDDDDD;
      padding: 0 20px;
      text-align: center;
    }

    ::backdrop {
      background-color: #555555;
      opacity: .6;
    }

    #init-dialog-error {
      color: red;
    }

    /* Loading Screen */

    #loading-overlay {
      border: 0;
      padding: 0;
      background: transparent;
      width: 100px;
      height: 100px;
      overflow: visible;
      box-shadow: none;
      outline: none;
    }

    #spinner {
      width: 48px;
      height: 48px;
      border: 5px dotted #FFF;
      border-radius: 50%;
      display: inline-block;
      position: relative;
      box-sizing: border-box;
      animation: rotation 2s linear infinite;
    }

    @keyframes rotation {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Page Template */

    #page-container {
      display: flex;
      flex-direction: row;
      background-color: #CCCCCC;
    }

    #left-menu,
    #right-contents {
      padding: 10px;
      height: calc(100vh - 20px);
      transition: all 1s ease-in-out .1s;
    }

    #page-container.left-menu-closed #left-menu {
      width: 0px;
    }

    #page-container.left-menu-closed #right-contents {
      width: 100vw;
    }

    #page-container.left-menu-open #left-menu {
      width: 310px;
    }

    #page-container.left-menu-open #right-contents {
      width: calc(100vw - 310px);
    }

    /* Collapsible Left Menu */

    #left-menu {
      background-color: #CCCCCC;
      /* border-right: 1px solid #999; */
      overflow-x: hidden;
    }

    /* Left Menu Add Application */

    #left-menu nav {
      margin-bottom: 16px;
    }

    /* #add-application {
      margin-top: 10px;
      margin-left: 10px;
    } */

    /* Left Menu Filters & Sorting Dropdown Menus */

    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #fff;
      border: 1px solid black;
      border-radius: 10px;
      padding: 10px;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
      z-index: 1;
    }

    .dropdown:hover .dropdown-content {
      display: block;
    }

    #filter-tags {
      min-height: 40vh;
      width: 100%;
    }

    /* Left Menu Application List */

    #left-menu-links {
      display: flex;
      flex-direction: column;
    }

    .application-list-entry {
      display: flex;
      flex-direction: row;
      flex-shrink: 0;
      flex-wrap: wrap;
      margin-bottom: 6px;
      cursor: pointer;
      border-radius: 3px;
    }

    .application-list-entry:last-of-type {
      margin-bottom: 50px;
    }

    .application-list-marker {
      width: 5px;
      background-color: dodgerblue;
      content: "";
      border-top-left-radius: 2px;
      border-bottom-left-radius: 2px;
    }

    .application-list-entry.opened .application-list-marker,
    .application-list-entry:hover .application-list-marker {
      background-color: darkblue;
    }

    .application-list-pos-comp {
      width: 265px;
      padding: 2px 0;
      padding-left: 5px;
      background-color: white;
      border-top-right-radius: 2px;
      border-bottom-right-radius: 2px;
    }

    .application-list-entry.rejected .application-list-marker {
      background-color: #AAAAAA;
    }

    .application-list-entry.rejected .application-list-pos-comp {
      text-decoration: line-through;
      color: #666666;
    }

    .application-list-entry.opened .application-list-pos-comp {
      /* background-color: #DDEDFF; */
      color: dodgerblue;
    }

    .application-list-position {
      width: 265px;
      font-size: 1rem;
    }

    .application-list-company {
      width: 265px;
      font-size: 0.8rem;
    }

    .list-group-label {
      font-weight: bold;
      margin-top: 16px;
      margin-bottom: 5px;
    }

    .list-group-label:first-of-type {
      margin-top: 0;
    }

    /* Right Pane Left Menu Toggle */

    #right-contents nav {
      margin-bottom: 16px;
    }

    /* #left-menu-toggle {
      margin-top: 10px;
      margin-left: 10px;
    } */

    /* Right Pane Form */

    #application-contents fieldset,
    #application-contents fieldset legend {
      background-color: #FFF;
      border: 0;
      margin: 0;
      padding: 0;
    }

    #application-contents fieldset {
      margin-top: -9px;
      margin-bottom: 8px;
      border-radius: 2px;
      border-left: 5px solid dodgerblue;
      box-sizing: border-box;
      padding: 14px;
      padding-bottom: 5px;
      padding-right: 18px;
    }

    #application-contents fieldset:first-of-type {
      margin-top: -10px;
    }

    #application-contents fieldset legend {
      position: relative;
      top: 14px;
      left: -5px;
      padding-left: 5px;
      /* border-left: 5px solid dodgerblue; */
      color: dodgerblue;
      border-top-left-radius: 2px;
    }

    #application-contents fieldset input,
    #application-contents fieldset select {
      margin-right: 20px;
      margin-bottom: 5px;
    }

    #application-contents fieldset select,
    #application-contents fieldset input[type=text],
    #application-contents fieldset input[type=email] {
      width: 150px;
    }

    #application-contents fieldset input[type=text]#input-offer-url,
    #application-contents fieldset input[type=text]#input-location,
    #application-contents fieldset input[type=text]#input-contact-name {
      width: 300px;
    }

    #application-contents fieldset textarea {
      width: 100%;
    }

    #application-contents fieldset label {
      font-size: .9rem;
      margin-right: 10px;
      width: 120px;
      display: inline-block;
    }

    #offer-url-link {
      font-size: .9rem;
    }

    .inline-input-group {
      display: inline-block;
    }

    /* Tags Inputs */

    fieldset #tags-input-group label,
    fieldset #tags-input-group select {
      width: 200px;
      margin-right: 0;
    }

    fieldset #tags-input-group input[type=text] {
      width: 142px;
      margin-right: 0px;
    }

    fieldset #tags-input-group button {
      width: 50px;
      margin-left: 0;
    }

    /* Repository Link */

    #repository {
      font-family: sans-serif;
      display: block;
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: dodgerblue;
      color: white;
      padding: 4px 8px;
      border: 1px solid darkblue;
      border-radius: 5px;
      font-size: .8rem;
    }

    #repository a,
    #repository a:hover,
    #repository a:visited {
      color: white;
      text-decoration: none;
    }

    #repository a:hover {
      text-decoration: underline;
    }

    /* Global Display Toggle */

    .display-none {
      display: none !important;
    }
  </style>
</head>

<body>
  <!-- Init dialog -->
  <dialog id="init-dialog">
    <h1>Welcome</h1>
    <p>Start by opening a work directory.</p>
    <button id="init-dialog-select-dir">Select directory</button>
    <p id="init-dialog-error"></p>
  </dialog>

  <div id="page-container" class="left-menu-closed">
    <!-- Left menu -->
    <div id="left-menu">
      <nav>
        <button id="add-application">+</button>
        <div class="dropdown">
          <button class="dropbtn">Tag filters</button>
          <div class="dropdown-content">
            <button id="filter-tags-reset">Clear filters</button>
            <select id="filter-tags" multiple></select>
          </div>
        </div>
        <div class="dropdown">
          <button class="dropbtn">Sort / Group</button>
          <div class="dropdown-content">
            <button id="list-sort-reset">Clear sort/group</button>
            <div>
              <input type="radio" name="list-sort-method" id="sort-date-asc" />
              <label for="sort-date-asc">Date (ASC)</label>
            </div>
            <div>
              <input type="radio" name="list-sort-method" id="sort-date-desc" />
              <label for="sort-date-desc">Date (DESC)</label>
            </div>

            <div>
              <input type="radio" name="list-sort-method" id="sort-status" />
              <label for="sort-status">Application Status</label>
            </div>
            <div>
              <input type="radio" name="list-sort-method" id="sort-app-email" />
              <label for="sort-app-email">Application Email</label>
            </div>
            <div>
              <input type="radio" name="list-sort-method" id="sort-location" />
              <label for="sort-location">Location</label>
            </div>
          </div>
        </div>
      </nav>
      <div id="left-menu-links"></div>
    </div>
    <!-- Right view port -->
    <div id="right-contents">
      <nav>
        <button id="left-menu-toggle">☰</button>
      </nav>
      <contents id="application-contents">
        <fieldset>
          <legend>Source</legend>
          <div>
            <label for="input-offer-url">Offer URL</label>
            <input type="text" name="input-offer-url" id="input-offer-url" />
            <a id="offer-url-link" href="#" target="_blank" rel="noopener noreferrer">Open URL ⤴</a>
          </div>
        </fieldset>
        <fieldset>
          <legend>References</legend>
          <div class="inline-input-group">
            <label for="input-position">Position</label><input type="text" name="input-position" id="input-position" />
          </div>
          <div class="inline-input-group">
            <label for="input-company">Company</label><input type="text" name="input-company" id="input-company" />
          </div>
          <div class="inline-input-group">
            <label for="input-location">Location</label><input type="text" name="input-location" id="input-location" />
          </div>
        </fieldset>
        <fieldset>
          <legend>Contact</legend>
          <div>
            <label for="input-contact-name">Name</label><input type="text" name="input-contact-name"
              id="input-contact-name" />
          </div>
          <div>
          </div>
          <div class="inline-input-group">
            <label for="input-contact-email">Email</label><input type="email" name="input-contact-email"
              id="input-contact-email" />
          </div>
          <div class="inline-input-group">
            <label for="input-contact-phone">Phone</label><input type="text" name="input-contact-phone"
              id="input-contact-phone" />
          </div>
        </fieldset>
        <fieldset>
          <legend>Application</legend>
          <div class="inline-input-group">
            <label for="input-application-email">Email</label><input type="email" name="input-application-email"
              id="input-application-email" />
          </div>
          <div class="inline-input-group">
            <label for="input-application-date">Date</label><input type="date" name="input-application-date"
              id="input-application-date" />
          </div>
        </fieldset>
        <fieldset>
          <legend>Status</legend>
          <div class="inline-input-group">
            <input type="checkbox" name="input-is-sent" id="input-is-sent" /><label for="input-is-sent">Is sent</label>
          </div>
          <div class="inline-input-group">
            <input type="checkbox" name="input-is-viewed" id="input-is-viewed" /><label for="input-is-viewed">Is
              viewed</label>
          </div>
          <div class="inline-input-group">
            <input type="checkbox" name="input-is-interviewing" id="input-is-interviewing" /><label
              for="input-is-interviewing">Is interviewing</label>
          </div>
          <div class="inline-input-group">
            <input type="checkbox" name="input-is-rejected" id="input-is-rejected" /><label for="input-is-rejected">Is
              rejected</label>
          </div>
        </fieldset>
        <fieldset>
          <legend>Offer</legend>
          <textarea name="input-offer" id="input-offer" width="60%"></textarea>
        </fieldset>
        <fieldset>
          <legend>Cover Letter</legend>
          <textarea name="input-cover-letter" id="input-cover-letter" width="60%"></textarea>
        </fieldset>
        <fieldset>
          <legend>Notes</legend>
          <textarea name="input-notes" id="input-notes" width="60%"></textarea>
        </fieldset>
        <fieldset>
          <legend>Others</legend>
          <div id="tags-input-group">
            <label for="input-add-tag-field">Add new tag</label>
            <br />
            <input type="text" name="input-add-tag-field" id="input-add-tag-field" /><button
              id="input-add-tag">+</button>
            <br />
            <label for="input-tags">Tags</label>
            <br />
            <select multiple name="input-tags" id="input-tags"></select>
          </div>
        </fieldset>
      </contents>
    </div>
  </div>

  <!-- Repo -->
  <div id="repository">
    <a href="https://github.com/my-opencode/application-tracker" target="_blank" rel="noopener noreferrer">GitHub Repo
      ⤴</a>
  </div>

  <!-- Loading overlay -->
  <dialog id="loading-overlay"><span id="spinner"></span></dialog>
  <script type="text/javascript">
    /**
     * @typedef {Object} DbObject
     * @property {String} updated
     * @property {Array<String>} tags
     * @property {Array<JobTracker>} data
     */
    /**
     * @typedef {null|(v:any)=>string|number} ApplicationListGroup
     */
    /**
     * @typedef {null|(a:any,b:any)=>number} ApplicationListSort
     */
    /**
    * The type of the state of the page
    * @typedef {Object} PageState
    * @property {FileSystemDirectoryHandle} dirH
    * @property {Set<String>} tags
    * @property {Array<String>} tagsArray
    * @property {Array<JobTracker>} db
    * @property {Boolean} isApplicationFilterEnabled
    * @property {ApplicationListGroup} applicationListGroup
    * @property {ApplicationListSort} applicationListSort
    * @property {Boolean} isLoading
    * 
    * @property {FileSystemDirectoryHandle} zDirH
    * @property {Set<String>} zTags
    * @property {Array<JobTracker>} zDb
    * @property {Boolean} zIsApplicationFilterEnabled
    * @property {ApplicationListGroup} zApplicationListGroup
    * @property {ApplicationListSort} zApplicationListSort
    * @property {Boolean} zIsLoading
    * 
    * @method pushToDb
    * @method addToTags
    */
    const DB_FILENAME = `tracker.db.json`;
    /**
     * Constants ids of DOM elements
     */
    var DOM_IDS = {
      addApplication: `add-application`,
      applicationContents: `application-contents`,
      filterTags: `filter-tags`,
      filterTagsReset: `filter-tags-reset`,
      initDialog: `init-dialog`,
      initDialogError: `init-dialog-error`,
      initDialogSelectDirBtn: `init-dialog-select-dir`,
      leftMenu: `left-menu`,
      leftMenuLinks: `left-menu-links`,
      leftMenuToggle: `left-menu-toggle`,
      loadingOverlay: `loading-overlay`,
      pageContainer: `page-container`,
      offerLink: `offer-url-link`,
      rightContents: `right-contents`,
      inputAddTag: `input-add-tag`,
      sort: {
        reset: `list-sort-reset`,
        dateAsc: `sort-date-asc`,
        dateDesc: `sort-date-desc`,
        status: `sort-status`,
        appEmail: `sort-app-email`,
        location: `sort-location`,
      },
      inputs: {
        offerUrl: `input-offer-url`,
        position: `input-position`,
        company: `input-company`,
        location: `input-location`,
        contactEmail: `input-contact-email`,
        contactPhone: `input-contact-phone`,
        contactName: `input-contact-name`,
        applicationEmail: `input-application-email`,
        applicationDate: `input-application-date`,
        isSent: `input-is-sent`,
        isViewed: `input-is-viewed`,
        isRejected: `input-is-rejected`,
        isInterviewing: `input-is-interviewing`,
        offer: `input-offer`,
        coverLetter: `input-cover-letter`,
        notes: `input-notes`,
        tagField: `input-add-tag-field`,
        tags: `input-tags`,
        messages: `input-messages`,
      },
    };
    var DOM_EVENTS = {
      change: `change`,
      click: `click`,
      update: `update`,
    };
    /** 
     * @name _pageState
     * @type {PageState} 
     */
    var pageState = {
      // z prefix is for intellisense order of suggestion
      // file system
      zDirH: undefined,
      // data
      zDb: [],
      zTags: new Set(),
      // data view modifiers
      zIsApplicationFilterEnabled: false,
      zApplicationListSort: null,
      zApplicationListGroup: null,
      // dom states
      zIsLoading: false,

      // getters
      get dirH() {
        return this.zDirH;
      },
      get db() {
        return new Proxy(
          this.zApplicationListSort
            ? this.zDb.toSorted(this.zApplicationListSort)
            : this.zDb,
          {
            get(target, p) {
              if ([`copyWithin`, `fill`, `pop`, `push`, `reverse`, `shift`, `sort`, `slice`, `unshift`].includes(p))
                throw new Error(`Mutating methods are not supported. Use a state mutator.`);
              return target[p];
            }
          }
        );
      },
      get tags() {
        return new Proxy(
          this.zTags,
          {
            get(target, p) {
              if ([`add`, `clear`, `delete`].includes(p))
                throw new Error(`Mutating methods are not supported. Use a state mutator.`);
              return target[p];
            }
          }
        );
      },
      get tagsArray() {
        return [...this.zTags].sort();
      },
      get isApplicationFilterEnabled() {
        return this.zIsApplicationFilterEnabled;
      },
      get applicationListGroup() {
        return this.zApplicationListGroup;
      },
      get applicationListSort() {
        return this.zApplicationListSort;
      },
      get isLoading() {
        return this.zIsLoading;
      },

      // mutators <-- this is where to add listeners
      set dirH(v) {
        this.zDirH = v;
      },
      set db(v) {
        this.zDb = v;
      },
      pushToDb(v) {
        this.zDb.push(v);
      },
      set isApplicationFilterEnabled(v) {
        this.zIsApplicationFilterEnabled = !!v;
      },
      set applicationListGroup(v) {
        this.zApplicationListGroup = v;
      },
      set applicationListSort(v) {
        this.zApplicationListSort = v;
      },
      set tags(v) {
        this.zTags = v;
      },
      addToTags(v) {
        this.zTags.add(v);
      },
      set isLoading(v) {
        this.zIsLoading = !!v;
        toggleDomLoadingOverlay();
      },

    };

    /**
     * Wrapper for document.getElementById
     * @param {String} id
     * @returns {HTMLElement}
     */
    function $id(id) {
      if (typeof id !== `string` || !id?.length) throw new TypeError(`function $id(id:string) requires a string argument.`);
      return document.getElementById(id);
    }

    /**
     * Wrapper for HTMLElement.addEventListener.
     * Accepts an id or element as target.
     * @param {HTMLElement|String} idOrEl target
     * @param {String} eventName DOM event name
     * @param {Function} handler event listener callback
     */
    function $on(idOrEl, eventName, handler) {
      const target = idOrEl instanceof HTMLElement ? idOrEl : $id(String(idOrEl));
      if (!target) throw new Error(`$on target not found.`);
      if (typeof eventName !== `string` || !eventName?.length) throw new TypeError(`function $on(id:string, eventName:string, handler:()=>any) requires a string 'eventName' argument.`);
      if (!handler || !(handler instanceof Function)) throw new TypeError(`function $on(id:string, eventName:string, handler:()=>any) requires a function 'handler' argument.`);
      target.addEventListener(eventName, handler);
    }

    // entry point
    $id(DOM_IDS.initDialog).showModal();

    // select folder
    $on(DOM_IDS.initDialogSelectDirBtn, DOM_EVENTS.click, selectDirectory);
    // open close left menu
    $on(DOM_IDS.leftMenuToggle, DOM_EVENTS.click, toggleLeftMenu);
    // add application button
    $on(DOM_IDS.addApplication, DOM_EVENTS.click, createNewApplication);
    // application form: add new tag
    $on(DOM_IDS.inputAddTag, DOM_EVENTS.click, addTag);
    // filtering
    $on(DOM_IDS.filterTags, DOM_EVENTS.change, handleFilterTags);
    $on(DOM_IDS.filterTagsReset, DOM_EVENTS.click, handleFilterTagsReset);
    // sorting
    $on(DOM_IDS.sort.reset, DOM_EVENTS.click, handleSorting);
    $on(DOM_IDS.sort.dateAsc, DOM_EVENTS.change, handleSorting);
    $on(DOM_IDS.sort.dateDesc, DOM_EVENTS.change, handleSorting);
    $on(DOM_IDS.sort.appEmail, DOM_EVENTS.change, handleSorting);
    $on(DOM_IDS.sort.status, DOM_EVENTS.change, handleSorting);
    $on(DOM_IDS.sort.location, DOM_EVENTS.change, handleSorting);

    /**
     * Shows an error message and throws if accessing FileSystem is not supported.
     */
    function onlyOnChrome() {
      if (!window.showDirectoryPicker) {
        $id(DOM_IDS.initDialogError).innerText = `Importer: This functionality only works on Chrome.`;
        throw new Error(`This functionality only works on Chrome.`);
      }
    }

    /**
     * Selects work directory.
     * Calls initWithData upon completion.
     * @param {MouseEvent} e
     */
    async function selectDirectory(e) {
      onlyOnChrome();
      let dirHandle = undefined;
      try {
        dirHandle = await window.showDirectoryPicker({
          mode: `readwrite`
        });
      }
      catch (err) {
        $id(DOM_IDS.initDialogError).innerText = `Importer: Operation cancelled.`;
        return;
      }
      if (!dirHandle) {
        $id(DOM_IDS.initDialogError).innerText = `Importer: Invalid Work directory.`;
        return;
      }
      pageState.dirH = dirHandle;

      initWithData();
      closeInitModal();
    }
    /**
     * Closes the init dialog
     */
    function closeInitModal() {
      $id(DOM_IDS.initDialog).close();
    }

    /**
     * Initializes the page with data from the file db.
     */
    async function initWithData() {
      pageState.isLoading = true;
      await loadDbFromFile();
      updateGUI();
      pageState.isLoading = false;
      toggleLeftMenu();
    }

    /**
     * Loads database from file or creates it if missing
     */
    async function loadDbFromFile() {
      let dbData;
      const dbH = await pageState.dirH.getFileHandle(DB_FILENAME, { create: true });
      const rawDb = await dbH.getFile();
      const txtDb = await rawDb.text();
      if (!txtDb) {
        dbData = await initializeDbFile();
      } else {
        dbData = JSON.parse(txtDb);
      }
      pageState.db = dbData.data.map(v => new JobTracker(v));
      pageState.tags = new Set(dbData.tags);
    }

    /**
     * Creates an empty database file
     * @returns {Promise<DbObject>}
     */
    async function initializeDbFile() {
      /** @type {DbObject} */
      const emptyDb = {
        "updated": (new Date()).toISOString(),
        "tags": [],
        "data": [
          (new JobTracker({ position: `?`, company: `?` })).toObject()
        ]
      };
      await writeFile(DB_FILENAME, JSON.stringify(emptyDb, null, " "));
      return Object.create(emptyDb);
    }

    /**
     * Writes a file to the File System.
     * @param {String} filename
     * @param {Any} contents Contents to write to the file.
     * @param {FileSystemDirectoryHandle} [directoryHandler] optional directory handler. Defaults to work directory.
     */
    async function writeFile(filename, contents, directoryHandler) {
      const _dirH = directoryHandler || pageState.dirH;
      const fileHandle = await _dirH.getFileHandle(filename, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(contents);
      await writable.close();
    }

    /**
     * Cycles left menu open & closed classes
     */
    function toggleLeftMenu() {
      const container = $id(DOM_IDS.pageContainer);
      if (container.classList.contains(`left-menu-open`)) {
        container.classList.remove(`left-menu-open`);
        container.classList.add(`left-menu-closed`);
      } else {
        container.classList.remove(`left-menu-closed`);
        container.classList.add(`left-menu-open`);
      }
    }

    /**
     * Updates the DOM contents with data
     */
    function updateGUI() {
      buildDomApplicationList();
      listTags();
      if (pageState.db.length > 0)
        openApplication(pageState.db[0]);
    }

    /**
     * Attaches the application to the content form inputs
     * @param {JobTracker} application
     */
    function openApplication(application) {
      decorateApplicationListEntry(application);
      updateOfferLink(application);
      for (const key of [`offerUrl`, `position`, `company`, `location`, `contactEmail`, `contactPhone`, `contactName`, `applicationDate`, `applicationEmail`, `offer`, `coverLetter`, `notes`]) {
        const elSrc = $id(DOM_IDS.inputs[key]);
        if (!elSrc) throw new Error(`Missing element for ${key}`);
        const el = elSrc.cloneNode(true);
        el.value = application[key];
        elSrc.parentNode.replaceChild(el, elSrc);
        el.addEventListener(DOM_EVENTS.change, function (e) {
          application[key] = e.target.value;
          if (key === `position` || key === `company`)
            updateApplicationListEntry(application);
          if (key === `offerUrl`)
            updateOfferLink(application);
          saveDb();
        });
      }
      for (const key of [`isSent`, `isViewed`, `isInterviewing`, `isRejected`]) {
        const elSrc = $id(DOM_IDS.inputs[key]);
        if (!elSrc) throw new Error(`Missing element for ${key}`);
        const el = elSrc.cloneNode(false);
        if (application[key]) {
          el.setAttribute(`checked`, `checked`);
          el.checked = true;
        } else {
          el.removeAttribute(`checked`);
          el.checked = false;
        }
        elSrc.parentNode.replaceChild(el, elSrc);
        el.addEventListener(DOM_EVENTS.change, function (e) {
          application[key] = e.target.checked;
          saveDb();
          if (key === `isRejected`)
            updateApplicationListEntry(application);
        });
      }
      {
        const key = `tags`;
        const elSrc = $id(DOM_IDS.inputs[key]);
        if (!elSrc) throw new Error(`Missing element for ${key}`);
        const el = elSrc.cloneNode(true);
        el.childNodes.forEach(node => {
          if (application.tags.has(node.value))
            node.setAttribute(`selected`, `selected`);
          else
            node.removeAttribute(`selected`);
        });
        elSrc.parentNode.replaceChild(el, elSrc);
        el.addEventListener(DOM_EVENTS.change, function (e) {
          e.target.childNodes.forEach(
            node => {
              if (node.selected)
                application[key].add(node.value);
            }
          );
          updateApplicationListEntry(application);
          saveDb();
        });
      }
    }

    /**
     * Creates a new application
     * Adds it to db
     * Opens it in editor form
     * Does not save to file
     */
    function createNewApplication() {
      const application = new JobTracker();
      pageState.pushToDb(application);
      appendDomListEntry(application);
      openApplication(application);
    }

    /**
     * Creates the left menu application list.
     * Adds replaces the contents of the list with the new list.
     * Applies sorting & grouping
     */
    function buildDomApplicationList() {
      // get element
      const containerEl = $id(DOM_IDS.leftMenuLinks);
      // reset element
      containerEl.innerHTML = ``;
      // grouping logic
      let prevGroup;
      const conditionalAppendDomListGroup = pageState.applicationListGroup === null
        ? () => { }
        : (application) => {
          const group = String(pageState.applicationListGroup(application));
          if (group !== prevGroup) {
            prevGroup = group;
            appendDomListGroup(group || `No value`, containerEl);
          }
        };
      // looping self sorting db
      for (const application of pageState.db) {
        conditionalAppendDomListGroup(application);
        appendDomListEntry(application, containerEl);
      }
    }
    /**
     * Adds a group label to the left menu application list
     * @param {String} group Label of the group.
     * @param {HTMLElement} [tgtEl] Optional list container element.
     */
    function appendDomListGroup(group, tgtEl) {
      const liGpEl = document.createElement(`div`);
      liGpEl.classList.add(`list-group-label`);
      liGpEl.innerText = group;
      (tgtEl || $id(DOM_IDS.leftMenuLinks)).appendChild(liGpEl);
    }
    /**
     * Adds an entry to the left menu application list
     * @param {JobTracker} application Application object to list.
     * @param {HTMLElement} [tgtEl] Optional list container element.
     */
    function appendDomListEntry(application, tgtEl) {
      const liEl = document.createElement(`div`);
      buildDomApplicationListEntry(liEl, application);
      (tgtEl || $id(DOM_IDS.leftMenuLinks)).appendChild(liEl);
    }
    /**
     * Updates one list entry.
     * @param {JobTracker} application
     */
    function updateApplicationListEntry(application) {
      const id = `link_${application.uid}`;
      const liEl = $id(id);
      buildDomApplicationListEntry(liEl, application);
    }
    /**
     * Sets the values of the attributes of an application list entry.
     * @param {HTMLElement} liEl <li> element
     * @param {JobTracker} application
     */
    function buildDomApplicationListEntry(liEl, application) {
      // reset for updates
      liEl.innerHTML = ``;
      liEl.setAttribute(`id`, `link_${application.uid}`);
      liEl.setAttribute(`data-tags`, `,${[...application.tags].join(`,`)},`);
      liEl.classList.add(`application-list-entry`);
      if (application.isRejected) liEl.classList.add(`rejected`);
      const markerEl = document.createElement(`div`);
      markerEl.classList.add(`application-list-marker`);
      const textEl = document.createElement(`div`);
      textEl.classList.add(`application-list-pos-comp`);
      const positionEl = document.createElement(`div`);
      positionEl.classList.add(`application-list-position`);
      positionEl.innerText = application.position;
      const companyEl = document.createElement(`div`);
      companyEl.classList.add(`application-list-company`);
      companyEl.innerText = application.company;
      textEl.appendChild(positionEl);
      textEl.appendChild(companyEl);
      liEl.appendChild(markerEl);
      liEl.appendChild(textEl);
      liEl.addEventListener(DOM_EVENTS.click, () => openApplication(application));
    }

    function decorateApplicationListEntry(application) {
      document.querySelector(`.application-list-entry.opened`)?.classList?.remove?.(`opened`);
      $id(`link_${application.uid}`).classList.add(`opened`);
    }

    /**
     * Updates the href value of the offer link.
     * @param {JobTracker} application
     */
    function updateOfferLink(application) {
      const el = $id(DOM_IDS.offerLink);
      el.href = application.offerUrl;
    }

    /**
     * Controls the creation of tag options
     */
    function listTags() {
      const selectEl = $id(DOM_IDS.inputs.tags);
      const filterEl = $id(DOM_IDS.filterTags);
      const append = AppendToTagList(selectEl, filterEl)
      for (const tag of pageState.tagsArray)
        append(tag);
    }
    /**
     * Creates a new tag
     * Adds it to application tags
     * Triggers tags select change event
     */
    function addTag() {
      const fieldEl = $id(DOM_IDS.inputs.tagField);
      const tag = fieldEl.value;
      fieldEl.value = ``;
      pageState.addToTags(tag);
      const selectEl = $id(DOM_IDS.inputs.tags);
      const filterEl = $id(DOM_IDS.filterTags);
      AppendToTagList(selectEl, filterEl)(tag, true);

      if ("createEvent" in document) {
        const evt = document.createEvent("HTMLEvents");
        evt.initEvent("change", false, true);
        selectEl.dispatchEvent(evt);
      }
      else {
        selectEl.fireEvent("onchange");
      }
    }
    /**
     * Curryied function taking tag select and tag filter elements
     * Returns a function taking tag and a selection flag
     * Appends a new tag option to each select and filter elements
     * @param {HTMLElement} selectEl
     * @param {HTMLElement} filterEl
     * @returns {(tag:string,selected?:boolean)=>void}
     */
    function AppendToTagList(selectEl, filterEl) {
      return function appendToTagList(tag, selected) {
        const optionEl = document.createElement(`option`);
        optionEl.setAttribute(`value`, tag);
        if (selected)
          optionEl.setAttribute(`selected`, `selected`);
        optionEl.innerText = tag;
        selectEl.appendChild(optionEl);
        const filterOptionEl = optionEl.cloneNode(true);
        filterOptionEl.setAttribute(`selected`, `selected`);
        filterEl.appendChild(filterOptionEl);
      }
    }

    /**
     * Returns a new uid value
     * @returns {String}
     */
    function createUid() {
      const n = new Date();
      let uid = `${n.getFullYear()
        }${String(n.getMonth() + 1).padStart(2, `0`)
        }${String(n.getDate()).padStart(2, `0`)
        }_${String(n.getHours()).padStart(2, `0`)
        }${String(n.getMinutes()).padStart(2, `0`)
        }${String(n.getSeconds()).padStart(2, `0`)
        }${String(n.getMilliseconds()).padStart(3, `0`)
        }_${String(Math.trunc(Math.random() * 999999)).padStart(6, `0`)
        }`;
      return uid;
    }
    /**
     * @class
     * @classdesc Class JobTracker that represents an application
     */
    function JobTracker(val) {
      /** @member {String} uid Unique identifier. */
      this.uid = (typeof val?.uid === `string`) ? val.uid : createUid();
      /** @member {String} offerUrl Link to the original offer. */
      this.offerUrl = (typeof val?.offerUrl === `string`) ? val.offerUrl : ``;
      /** @member {String} position Position of the offer.       */
      this.position = (typeof val?.position === `string`) ? val.position : ``;
      /** @member {String} company Name of the company or recruitment agency.       */
      this.company = (typeof val?.company === `string`) ? val.company : ``;
      /** @member {String} location Geographical location.       */
      this.location = (typeof val?.location === `string`) ? val.location : ``;
      /** @member {String} contactEmail Email contact.       */
      this.contactEmail = (typeof val?.contactEmail === `string`) ? val.contactEmail : ``;
      /** @member {String} contactPhone Phone contact.       */
      this.contactPhone = (typeof val?.contactPhone === `string`) ? val.contactPhone : ``;
      /** @member {String} contactName Phone contact.       */
      this.contactName = (typeof val?.contactName === `string`) ? val.contactName : ``;
      /** @member {String} applicationEmail Email used for the application.       */
      this.applicationEmail = (typeof val?.applicationEmail === `string`) ? val.applicationEmail : ``;
      /** @member {String} applyDate Date of application.       */
      this.applicationDate = (typeof val?.applicationDate === `string`) ? val.applicationDate : ``;
      /** @member {String} offer Text of the offer.       */
      this.offer = (typeof val?.offer === `string`) ? val.offer : ``;
      /** @member {String} coverLetter Text of the cover letter.       */
      this.coverLetter = (typeof val?.coverLetter === `string`) ? val.coverLetter : ``;
      /** @member {String} notes Text notes. */
      this.notes = (typeof val?.note === `string`) ? val.notes : ``;
      /** @member {Boolean} isSent */
      this.isSent = !!val?.isSent;
      /** @member {Boolean} isViewed */
      this.isViewed = !!val?.isViewed;
      /** @member {Boolean} isInterviewing */
      this.isInterviewing = !!val?.isInterviewing;
      /** @member {Boolean} isRejected */
      this.isRejected = !!val?.isRejected;
      /** @member {Set<String>} tags Text tags. */
      this.tags = new Set(Array.isArray(val?.tags) ? val.tags : []);
      /** @member {Array<String>} messages Exchanged messages. */
      this.messages = Array.isArray(val?.messages) ? val.messages : [];
    }
    /**
     * Method toJSON
     * Returns a json representation of an application
     * @name JobTracker#toJSON
     * @function
     * @returns {String}
     */
    JobTracker.prototype.toJSON = function () {
      return JSON.stringify(this.toObject());
    }
    /**
     * Method toObject
     * Returns the database representation of an application
     * @name JobTracker#toObject
     * @function
     * @returns {Object}
     */
    JobTracker.prototype.toObject = function () {
      const obj = { ...this };
      obj.tags = [...this.tags];
      return obj;
    }

    /**
     * Saves state to database file
     */
    async function saveDb() {
      /** @type {DbObject} */
      const obj = {
        updated: (new Date()).toISOString(),
        tags: pageState.tagsArray,
        // directly accessing the raw unsorted data
        data: pageState.zDb.map(app => app.toObject())
      };
      console.log(`saving`);
      await writeFile(DB_FILENAME, JSON.stringify(obj, null, ` `));
    }

    /**
     * Handles a filter event
     * Controls filtering
     */
    function handleFilterTags() {
      filterList(listSelectedTags());
      pageState.isApplicationFilterEnabled = true;
    }
    /**
     * Lists tags selected for filtering
     */
    function listSelectedTags() {
      const tags = [];
      $id(DOM_IDS.filterTags).childNodes.forEach(optN => {
        if (optN.selected) tags.push(optN.value);
      });
      return tags;
    }
    /**
     * Applies filtering to the DOM elements
     * @param {Array<String>} tagsToKeep
     */
    function filterList(tagsToKeep) {
      const elements = document.querySelectorAll(`#${DOM_IDS.leftMenuLinks} .application-list-entry`);
      elements.forEach(
        liEl => {
          const tags = liEl.dataset.tags;
          if (tagsToKeep.some(t => tags.includes(`,${t},`)))
            liEl.classList.remove(`display-none`);
          else
            liEl.classList.add(`display-none`);
        }
      );
    }
    /**
     * Handles a filter reset event
     */
    function handleFilterTagsReset() {
      pageState.isApplicationFilterEnabled = false;
      $id(DOM_IDS.filterTags).childNodes.forEach(optN => optN.selected = true);
      filterList(pageState.tagsArray);
    }

    /**
     * Handles a sorting event
     * Sets state grouping function
     * Sets state sorting function
     * Calls list update
     * @param {Event} e
     */
    function handleSorting(e) {
      if (e.target.id === `list-sort-reset`) {
        resetSortingMenu();
        pageState.applicationListSort = null;
        pageState.applicationListGroup = null;
      } else {
        const sort = document.querySelector(`input[name=list-sort-method]:checked`).id;
        if (sort === `sort-date-asc`) {
          const g = v => v.applicationDate;
          pageState.applicationListGroup = g;
          pageState.applicationListSort = (a, b) => g(a) < g(b) ? -1 : g(a) > g(b) ? 1 : 0;
        } else if (sort === `sort-date-desc`) {
          const g = v => v.applicationDate;
          pageState.applicationListGroup = g;
          pageState.applicationListSort = (a, b) => g(a) < g(b) ? 1 : g(a) > g(b) ? -1 : 0;
        } else if (sort === `sort-status`) {
          // returns a bitmask of the higher bit value
          const g = a => new StatusFlag(a);
          pageState.applicationListGroup = g;
          pageState.applicationListSort = (a, b) => g(a) - g(b);
        } else if (sort === `sort-app-email`) {
          const g = v => v.applicationEmail;
          pageState.applicationListGroup = g;
          pageState.applicationListSort = (a, b) => g(a) < g(b) ? -1 : g(a) > g(b) ? 1 : 0;
        } else if (sort === `sort-location`) {
          const g = v => v.location;
          pageState.applicationListGroup = g;
          pageState.applicationListSort = (a, b) => g(a) < g(b) ? -1 : g(a) > g(b) ? 1 : 0;
        } else
          throw new Error(`Unsupported sort method "${sort}"`);
      }
      buildDomApplicationList();
    }
    /**
     * StatusFlag class
     * Represents the advancement status of an application.
     * May return a bit map with valueOf
     * May return a string label with toString
     * @param {JobTracker} application
     */
    function StatusFlag(application) {
      const a = application;
      this.value = 8 * a.isRejected || 4 * a.isInterviewing || 2 * a.isViewed || 1 * a.isSent;
      this.label = this.value === 8 ? `Status: rejected`
        : this.value === 4 ? `Status: interviewing`
          : this.value === 2 ? `Status: viewed`
            : this.value === 1 ? `Status: sent` : `Status: unknown`;
    }
    /**
     * Method valueOf
     * @returns {Number}
     */
    StatusFlag.prototype.valueOf = function () { return this.value; };
    /**
     * Method toString
     * @returns {String}
     */
    StatusFlag.prototype.toString = function () { return this.label; };
    /**
     * Resets the radio inputs of the sorting menu
     */
    function resetSortingMenu() {
      document
        .querySelectorAll(`input[name=list-sort-method]`)
        .forEach(n => n.checked = false);
    }

    /**
     * Toggles the loading overlay based on the value of isLoading
     */
    function toggleDomLoadingOverlay() {
      if (pageState.isLoading)
        $id(DOM_IDS.loadingOverlay).showModal();
      else
        $id(DOM_IDS.loadingOverlay).close();
    }
  </script>
</body>

</html>